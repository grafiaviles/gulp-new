<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="/static/RDF/site/content/guided-selling/css/main.min.css">
    <title>Guided Selling - Falabella.com</title>
</head>

<body>

    <main class="main-module">
        <!-- Spinners -->
        <div class="cont-cargador">
            <div class="lds-ring">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
        <section class="home-category">
            <div class="title-container">
                <img width="15" src="/static/RDF/site/content/guided-selling/img/sale/arrow.svg" title="Arrow">
                <h1 class="title-text">Búsqueda por categorías principales</h1>
            </div>
        </section>
    </main>

    <script>
        //@@Array of Object with taxonomies
        //hide-only-tablet-desktop
        function guidedSellingMenuWrapper(array, divClass) {
            let accordionContainer = document.querySelector(".home-category");
            let accordion = document.createElement("div");
            accordion.classList.add("accordion", divClass);
            let isDesktop = divClass === "hide-only-mobile" ? true : false;
            array.forEach((el, index) => {
                let header = createSectionHeader(el.label, index + 1);
                accordion.appendChild(header);
                accordion.appendChild(guidedSellingFirstLevel(el, index + 1, isDesktop));
            });

            accordionContainer.appendChild(accordion);
            if (isDesktop === true) {
                allocateAccordionSection(accordion);
            }
        }

        //@@object with a label and array of subCategories, index, true or false

        function allocateAccordionSection(div) {

            let accordionArray = div.querySelectorAll(".accordion-section-content");
            let accordionHeaderArray = div.querySelectorAll(".accordion-section");
            let position;
            accordionArray.forEach((el, index) => {
                position = (Math.floor(index / 3) * 3 + 3);
                div.insertBefore(el, accordionHeaderArray[position])
            });
        }

        function guidedSellingFirstLevel(object, index, isDesktop) {

            // Create Section with object.label
            let dynamicSubMenu = document.createElement("div");
            dynamicSubMenu.classList.add("dynamic-sub-menu");
            object.subCategories.forEach((el) => {
                dynamicSubMenu.appendChild(guidedSellingSecondLevel(el));
            });
            let accordionSection = createAccordionSection(index);
            accordionSection.appendChild(createTriangle(index, isDesktop));
            accordionSection.appendChild(dynamicSubMenu);
            return accordionSection;
        }

        function createSectionHeader(label, index) {
            let sectionHeaderDiv = document.createElement("div");
            sectionHeaderDiv.classList.add("accordion-section", "grid-1-3-ipad", buildHeaderClass(label));
            let sectionHeaderLink = document.createElement("a");
            sectionHeaderLink.innerText = label === "Hombre" ? "Moda Hombre" : label;
            sectionHeaderLink.setAttribute("href", "#accordion-" + index);
            sectionHeaderLink.classList.add("accordion-section-title");
            sectionHeaderDiv.appendChild(sectionHeaderLink);

            return sectionHeaderDiv;
        }

        function buildHeaderClass(sentence) {
            let fixedSentence = sentence.toLowerCase().replace(/ /g, "-");
            if (fixedSentence === "electro-y-tecnología") {
                fixedSentence = "tecnologia";
            }
            if (fixedSentence === "niños") {
                fixedSentence = "ninos";
            }

            if (fixedSentence === "hombre") {
                fixedSentence = "moda-hombre";
            }
            return "bg-" + fixedSentence;
        }

        function createAccordionSection(number) {
            let accordionElement = document.createElement("div");
            accordionElement.id = "accordion-" + number;
            accordionElement.classList.add("accordion-section-content");
            return accordionElement;
        }

        function createTriangle(number, boolean) {

            let triangleSpan = document.createElement("span");
            if (boolean) {
                switch (number) {
                    case 1:
                    case 4:
                    case 7:
                    case 10:
                        triangleSpan.classList.add("triangulo-left");
                        break;
                    case 2:
                    case 5:
                    case 8:
                    case 11:
                        triangleSpan.classList.add("triangulo-center");
                        break;
                    case 3:
                    case 6:
                    case 9:
                    case 12:
                        triangleSpan.classList.add("triangulo-right");
                        break;
                    default:
                        triangleSpan.classList.add("triangulo-left");
                        break;
                }
            } else {
                triangleSpan.classList.add("triangulo-center");
            }

            return triangleSpan;
        }

        //Receives an object with label, a link, and array of leafCategories label: "TV ", link: "/category/cat1012/TV", leafCategories: Array(5)
        function guidedSellingSecondLevel(object) {

            //create level 2 item
            let secondLevelItemUL = document.createElement("ul");
            let secondLevelItem = document.createElement("li");
            let secondLevelItemLink = document.createElement("a");
            secondLevelItemLink.classList.add("title-sub-category");
            secondLevelItemLink.innerText = object.label;
            secondLevelItemLink.setAttribute("href", "/falabella-cl" + object.link);
            secondLevelItem.appendChild(secondLevelItemLink);

            //append secondlevel to UL
            secondLevelItemUL.appendChild(secondLevelItem);
            object.leafCategories.forEach((el) => {
                    //append each third to the corresponding UL
                    secondLevelItemUL.appendChild(guidedSellingThirdLevel(el));
                })
                //this is second level wrapper, a div
            let secondLevelItemWrapper = document.createElement("div");
            secondLevelItemWrapper.classList.add("sub-menu");
            secondLevelItemWrapper.appendChild(secondLevelItemUL);
            //return Div to the first level handler
            return secondLevelItemWrapper;;
        }
        //label: "Televisores LED", link: "/category/cat7190148/Televisores-LED", isHighlightLink: false
        function guidedSellingThirdLevel(object) {
            //create third level
            let thirdLevelItem = document.createElement("li");
            let thirdLevelItemLink = document.createElement("a");
            thirdLevelItemLink.classList.add("link-sub-category");
            thirdLevelItemLink.innerText = object.label;
            thirdLevelItemLink.setAttribute("href", "/falabella-cl" + object.link);
            thirdLevelItem.appendChild(thirdLevelItemLink);
            if (object.isHighlightLink === true) {
                thirdLevelItemLink.classList.add("last-bold");
            }
            return thirdLevelItem;
        }

        //XMLHttpRequest

        var guidedSellingXMLHTTP = new XMLHttpRequest();
        var guidedSellingURL = "/rest/model/falabella/rest/browse/BrowseActor/get-header-main-menu";
        var guidedSellingFormData = new FormData();
        guidedSellingFormData.append("ACCESS-CHANNEL", "GUIDEDSELLING");
        guidedSellingFormData.append("ACCESS_KEY", "GUIDEDSELLING_get-header-main-menu");
        guidedSellingFormData.append("ACCESS-TIMESTAMP", "Tue Sep 04 12:38:20 GMT-04:00 2018");
        guidedSellingFormData.append("ACCESS-SIGN", "7778c20d1c693371fb1785fd6264d4972d7f64693cb5fd787d53d177414f3650");

        guidedSellingXMLHTTP.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                var daResponse = JSON.parse(this.responseText);
                document.querySelector(".cont-cargador").classList.add("hide");
                guidedSellingMenuWrapper(daResponse.state.rootCategories, "hide-only-mobile");
                guidedSellingMenuWrapper(daResponse.state.rootCategories, "hide-only-tablet-desktop");

                //cesar script
                function close_accordion_section() {
                    document.querySelectorAll('.accordion .accordion-section-title').forEach((el) => {
                        el.classList.remove('active')
                    });
                    document.querySelectorAll('.accordion .accordion-section-content').forEach((el) => {
                        if (el.classList.contains('open')) {
                            el.classList.remove('open');
                        }

                    });
                }

                var accordionSectionTitles = document.querySelectorAll('.accordion-section-title');
                accordionSectionTitles.forEach((el) => {
                    el.addEventListener("click", (e) => {

                        var currentAttrValue = e.target.getAttribute('href');
                        if ((e.target).classList.contains('active')) {
                            close_accordion_section();
                        } else {
                            close_accordion_section();

                            // Add active class to section title
                            e.target.classList.add('active');
                            // Open up the hidden content panel
                            document.querySelectorAll(currentAttrValue).forEach((el) => {
                                el.classList.add('open')
                            });

                        }

                        e.preventDefault();

                    });
                });

            }
        }

        guidedSellingXMLHTTP.open("GET", guidedSellingURL, true);
        if (document.location.href.match(/falabella-cl/)) {
            guidedSellingXMLHTTP.send(guidedSellingFormData);
        } else {
            guidedSellingXMLHTTP.send();
        }
    </script>
</body>